[tools]
go = "1.25.6"

[env]
DB_DSN = "host=localhost port=5432 user=pcast password=pcast dbname=pcast sslmode=disable"
TEST_DB_DSN = "host=localhost port=5432 user=pcast password=pcast dbname=pcast_test sslmode=disable"

[tasks.default]
description = "Install dependencies and build"
depends = ["install", "build"]

[tasks.install]
description = "Install dependencies and tools (swag, goose, sqlc)"
run = """
go mod download
go install github.com/swaggo/swag/cmd/swag@latest
go install github.com/pressly/goose/v3/cmd/goose@latest
go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
"""

[tasks.build]
description = "Build with race detector"
run = "go build -o target/ -race ."

[tasks.test]
description = "Run all tests with race detector"
run = "go test -v -race ./..."

[tasks.run]
description = "Run the API server"
run = "go run -race ."

[tasks.docs]
description = "Generate Swagger documentation"
run = "swag init --parseDependency --parseInternal"

[tasks.sqlc]
description = "Generate sqlc code"
run = "sqlc generate"

# Database migration tasks
[tasks."migrate:up"]
description = "Run database migrations"
run = "goose postgres \"$DB_DSN\" up"
dir = "db/migrations"

[tasks."migrate:down"]
description = "Rollback last migration"
run = "goose postgres \"$DB_DSN\" down"
dir = "db/migrations"

[tasks."migrate:status"]
description = "Check migration status"
run = "goose postgres \"$DB_DSN\" status"
dir = "db/migrations"

[tasks."migrate:create"]
description = "Create a new migration (usage: mise run migrate:create name=migration_name)"
run = "goose create {{arg(name=\"name\")}} sql"
dir = "db/migrations"

# Test database migration tasks
[tasks."migrate:test:up"]
description = "Run test database migrations"
run = "goose postgres \"$TEST_DB_DSN\" up"
dir = "db/migrations"

[tasks."migrate:test:down"]
description = "Rollback test database migrations"
run = "goose postgres \"$TEST_DB_DSN\" down"
dir = "db/migrations"

# Test database setup tasks
[tasks."db:start"]
description = "Start PostgreSQL container"
run = "docker compose up -d db"
dir = "docker"

[tasks."db:stop"]
description = "Stop PostgreSQL container"
run = "docker compose down"
dir = "docker"

[tasks."db:test:create"]
description = "Create test database (requires PostgreSQL to be running)"
run = """
docker exec pcast-api-db-1 psql -U pcast -tc "SELECT 1 FROM pg_database WHERE datname = 'pcast_test'" | grep -q 1 || \
docker exec pcast-api-db-1 psql -U pcast -c "CREATE DATABASE pcast_test"
"""

[tasks."db:test:drop"]
description = "Drop test database"
run = "docker exec pcast-api-db-1 psql -U pcast -c \"DROP DATABASE IF EXISTS pcast_test\""

[tasks."db:test:setup"]
description = "Setup test database (start db, create test db, run migrations)"
depends = ["db:start"]
run = """
echo "Waiting for PostgreSQL to be ready..."
sleep 2
mise run db:test:create
mise run migrate:test:up
echo "Test database setup complete!"
"""

[tasks."db:test:reset"]
description = "Reset test database (drop, create, migrate)"
run = """
mise run db:test:drop
mise run db:test:create
mise run migrate:test:up
echo "Test database reset complete!"
"""
